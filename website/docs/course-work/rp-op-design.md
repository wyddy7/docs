# Проектирование РП и ОП для процессорной системы

## Содержание

1. Исследование библиотечного модуля altsyncram в базовой версии проекта module_OP
2. Создание модуля регистровой памяти для учебного процессора путем дополнительного редактирования библиотечного модуля памяти altsyncram
3. Создание модуля РП с использованием помощника MegaWizard Plug-In Manager
4. Создание модуля ОП с помощью MegaWizard Plug-In Manager
5. Создание модуля РП с использованием шаблона на языке VHDL
6. Создание модуля регистровой памяти для конвейерного процессора

## 1. Исследование библиотечного модуля altsyncram в базовой версии проекта module_OP

Целью базовой версии этого проекта является изучение библиотечного параметризованного модуля синхронной памяти для последующего его использования в учебных проектах.

Все файлы проектов, рассматриваемых в методическом пособии, находятся в папке OP. И сам проект, и его базовая версия носит название `module_OP`. Модулем верхнего уровня в ней является схемный проект, содержащийся в файле `Module_altsyncram.bdf`. Он создан в QUARTUS II версии 13.1 из библиотечного модуля `altsyncram`, путем редактирования его портов и параметров. В методическом пособии проводится исследование этого модуля для определения возможности его использования в курсовой работе для реализации на его основе оперативной (ОП) и регистровой памяти (РП) учебного процессора.

### 1.1 Как создан проект

**Создание схемного файла:**

1. В меню File выбираем строку New…
2. Задаем тип создаваемого файла Block Diagram/Schematic File
3. Из библиотеки QII из раздела megafunctions выбираем тип мегафункции storage, модуль altsyncram и добавляем его символ в схемный проект

**Редактирование библиотечного модуля:**

1. Выделяем символ на схеме
2. В контекстном меню выбираем Properties
3. Во вкладке General присваиваем экземпляру редактируемого модуля памяти имя "РП"
4. В вкладке Ports редактируем внешние порты экземпляра модуля памяти
5. В вкладке Parameter выполняем редактирование параметров создаваемого экземпляра модуля регистровой памяти

В соответствии с ТЗ регистровая память учебного процессора содержит восемь восьмиразрядных регистров. Поэтому в экземпляре модуля РП для каждого порта используем трехразрядную адресную шину и две восьмиразрядные шины данных, причем отдельные для записи и считывания данных.

**Сигналы модуля РП:**

- `rden_a` и `rden_b` - разрешают чтение из соответствующих портов памяти
- `wren_a` и `wren_b` - разрешают запись в РП через порты а и b, соответственно
- `clock0` и `clock1` - используются в качестве тактовых для обоих портов
- `clocken0` и `clocken1` - разрешают модулю РП реагировать на тактовые сигналы

В процессе настройки и редактирования параметров модуля памяти можно задать файл, который будет использован для инициализации памяти. В предлагаемом проекте таким файлом является файл `mem_file.hex`.

### 1.2 Моделирование созданного экземпляра модуля РП

Для исследования поведения созданного экземпляра модуля РП подготовлен файл с временными диаграммами `test_RP.vwf`, также входящий в состав проекта.

**Особенности работы модуля РП:**

- Информация на выходе первого порта РП появляется с задержкой в два такта, относительно задаваемого на его входе адреса
- На выходе второго порта информация появляется в том же такте по положительному фронту синхросигнала, после выставления нового адреса на шине адреса `address_b`
- При отсутствии сигнала разрешения чтения на выходной шине сохраняется последнее считанное значение
- При отсутствии тактового сигнала выходные данные не изменяются

Для отображения информации на адресных шинах РП на временных диаграммах используется десятичная форма представления чисел без знака, на шинах данных РП - шестнадцатеричная форма представления чисел без знака. Для остальных сигналов используется бинарное представление.

## 2. Создание модуля регистровой памяти для учебного процессора путем дополнительного редактирования библиотечного модуля памяти altsyncram

### 2.1 Рекомендации по использованию библиотечного модуля для реализации на его основе памяти регистровой

На основании исследования библиотечного модуля памяти altsyncram, делаем следующее заключение о возможности его применения для реализации регистровой памяти учебного процессора:

1. Для тактирования обоих портов РП достаточно использовать один синхронизирующий сигнал. В следующей версии проекта РП он назван `clock0`.
2. Сигналы `clocken0` и `clocken1`, разрешающие тактирование обоих портов памяти, являются избыточными, поэтому в следующей версии проекта РП использовать их не будем.
3. Сигналы `rden_a`, `rden_b`, разрешающие чтение из первого и второго портов, также не нужны для реализации РП. Пусть чтение из РП будет разрешено всегда.
4. Буферный регистр для фиксации считываемых с первого порта данных в РП также не нужен. Помимо аппаратных затрат он еще и вносит дополнительную задержку в один такт.

### 2.2 Вторая версия проекта РП

На основе базовой версии проекта `module_OP` создана новая версия проекта с именем `RP_from_altsyncram`. Новая версия получена путем дополнительного редактирования библиотечного модуля памяти в соответствии с рекомендациями, изложенными выше.

**Изменения во второй версии:**

- Фиксация считываемых из первого порта данных теперь не выполняется
- Для тактирования обоих портов теперь используется единый тактовый сигнал `clock0`
- Удалены невостребованные входные сигналы

Внесены изменения и в файл с временными диаграммами для тестирования РП. Они свелись к удалению невостребованных входных сигналов. Измененный файл теперь называется `test_for_RP1`. Он также содержится в проекте.

Выполнив моделирование, убеждаемся в полной работоспособности созданного экземпляра модуля памяти с именем `RP_1`.

## 3. Создание модуля РП с использованием помощника MegaWizard Plug-In Manager

### 3.1 Третья версия модуля РП

Целью этой версии проекта является знакомство студентов с менеджером мегафункций, встроенным в пакет QII.

**Создание проекта:**

1. Создаем новую версию проекта с именем `RP_from_megawizard`
2. При обращении в библиотеку QII нажимаем кнопку MegaWizard Plug-In Manager
3. В первом окне выбираем создание новой конфигурации мегафункции
4. В следующем окне выбираем RAM: 2-PORT, язык описания, и задаем имя формируемого файла
5. Указываем режим использования двух портов модуля памяти (оба порта используются для чтения и записи)
6. Указываем число слов в памяти и разрядность портов (восемь восьмиразрядных слов)
7. Задаем режим тактирования модуля памяти (единый сигнал синхронизации для обоих портов РП)
8. Настраиваем дополнительные параметры (отказ от использования выходных буферных регистров)
9. Задаем имя файла для инициализации РП
10. Выбираем выходные файлы проекта

**Сформированные файлы:**

- `RP2.vhd` - описание созданного компонента модуля РП на языке VHDL
- `RP2.cmp` - декларация созданного компонента регистровой памяти
- `RP2.bsf` - символьный файл модуля РП
- `RP2_inst` - шаблон для установки созданного компонента в проект верхнего уровня

Для тестирования вновь созданного модуля памяти в проекте имеется файл `test_for_RP2`. Он отличается от файла `test_for_RP1` только названием тактового сигнала. Теперь он называется просто `clock`. Выполнив моделирование созданного мегавизардом модуля регистровой памяти RP2, убеждаемся в его полной работоспособности и, следовательно, возможности использования его в проекте учебного процессора.

### 3.2 Анализ файлов, сформированных менеджером MegaWizard

Менеджером MegaWizard создаются файлы, необходимые для использования модуля РП в проекте учебного процессора. Файлы с расширением `.cmp` содержат декларацию компонентов, а файлы с суффиксом `_inst` - шаблоны для установки компонентов в проект верхнего уровня.

**Сформированные файлы:**

- `RP2.vhd` - описание созданного компонента модуля РП на языке VHDL. Его можно найти в папке с проектом.
- `RP2.cmp` - декларация созданного компонента регистровой памяти с именем RP2. Содержимое этого файла приведено в листинге 1.
- `RP2.bsf` - символьный файл модуля РП
- `RP2_inst` - шаблон для установки созданного компонента в проект верхнего уровня. Содержимое этого файла приведено в листинге 2. В нашем случае проектом верхнего уровня будет учебный процессор.

**Листинг 1.** Содержимое созданного мегавизардом файла с декларацией компонента RP2.

```cmp
[Здесь должен быть код из файла RP2.cmp]
```

**Листинг 2.** Подготовленный мегавизардом шаблон для установки компонента RP2 в проект учебного процессора.

```vhdl
[Здесь должен быть код из файла RP2_inst.vhd]
```

## 4. Создание модуля ОП с помощью MegaWizard Plug-In Manager

### 4.1 Рекомендации по использованию библиотечного модуля для реализации на его основе оперативной памяти для учебного процессора

На основании анализа поведения библиотечного модуля altsyncram, делаем следующее заключение относительно реализации на его основе оперативной памяти для учебного процессора:

1. В соответствии с ТЗ оперативная память ОП в процессорной системе должна содержать 256 восьмиразрядных слов
2. Для доступа ко всему адресному пространству ОП будем использовать восьмиразрядную шину адреса `address_OP`
3. Второй порт для реализации ОП не требуется, поэтому в библиотечном модуле памяти будем использовать один единственный порт
4. Буферный регистр для фиксации считываемых из ОП данных также не требуется
5. Для разрешения записи в ОП будем использовать сигнал `wr_en_OP`
6. Во время записи на выходной шине будут присутствовать вновь записываемые данные
7. Потребуется файл инициализации памяти для размещения программного кода и исходных данных

### 4.2 Версия проекта модуля ОП

Модуль оперативной памяти для учебного процессора создан с использованием MegaWizard Plug-In Manager аналогичным образом, с учетом рекомендаций, изложенных выше.

**Характеристики модуля ОП:**

- Размер: 256 восьмиразрядных слов
- Адресная шина: 8 разрядов
- Один порт для чтения и записи
- Без выходных буферных регистров
- Файл инициализации: `OP_init.mif`

Для тестирования модуля ОП подготовлен файл инициализации памяти с именем `OP_init.mif`. Последовательность входных сигналов для тестирования модуля ОП находится в файле `test_for_OP`, который входит в состав проекта.

Моделирование ОП показало его полную работоспособность и, следовательно, возможность использования его в качестве оперативной памяти в проектируемой процессорной системе.

### 4.3 Анализ файлов, сформированных менеджером MegaWizard

Менеджером MegaWizard создаются следующие файлы:

- `Module_OP.vhd` - описание созданного компонента модуля ОП на языке VHDL. Его можно найти в папке с проектом.
- `Module_OP.cmp` - декларация созданного компонента оперативной памяти с именем Module_OP. Его содержимое приведено в листинге 3.
- `Module_OP.bsf` - символьный файл модуля ОП
- `Module_OP_inst` - шаблон для установки созданного компонента в проект верхнего уровня. В нашем случае таким проектом будет учебный процессор. Сам шаблон показан в листинге 4.

**Листинг 3.** Содержимое файла Module_OP.cmp

```cmp
[Здесь должен быть код из файла Module_OP.cmp]
```

**Листинг 4.** Шаблон для вставки компонента ОП в проект.

```vhdl
[Здесь должен быть код из файла Module_OP_inst.vhd]
```

Модуль ОП реализован с использованием ресурсов блочной памяти в кристалле ПЛИС. Из 23 внешних выводов универсального библиотечного модуля памяти altsyncram в реализованном компоненте ОП используется только пять.

## 5. Создание модуля РП с использованием шаблона на языке VHDL

### 5.1 Четвертая версия модуля РП

В этом разделе рассматривается проектирование модуля РП для учебного процессора на языке VHDL, с использованием шаблона из пакета QII.

**Создание проекта:**

1. В меню Project выбираем команду Revisions…
2. В появившемся окне выбираем строку New revision и присваиваем ей имя `RP_from_template`
3. Создаем новый VHDL файл, сохраняем его с именем `RP_from_template`
4. В файле вызываем окно вставки шаблона
5. Выбираем VHDL > Full Designs > RAMs and ROMs > True Dual-Port RAM (single clock)
6. Выполняем редактирование шаблона:
   - Меняем разрядность адреса на три
   - Заменяем имя модуля памяти на собственное имя
   - Задаем первоначальное содержимое РП

### 5.2 Моделирование созданного экземпляра модуля РП

В файле `test_for_RP3` содержатся временные диаграммы для моделирования РП. Моделирование подтверждает корректное поведение созданного модуля РП.

**Особенности реализации:**

В отличие от предыдущих проектов, модуль РП теперь реализован полностью из элементов памяти, входящих в состав логических ячеек ПЛИС. Потребовалось 80 таких элементов:
- 64 элемента для самих регистров (8 штук по 8 разрядов)
- 16 элементов для фиксации считываемых из РП данных (2*8, в каждом порту по положительному фронту)

### 5.3 Сравнительный анализ разных версий проекта РП

Сравнительный анализ рассмотренных четырех версий проекта регистровой памяти можно выполнить с помощью команды Project => Revisions… В появляющемся окне нажимаем кнопку Compare…

**Версии проекта РП:**

1. Базовая версия - `module_OP` (исследование библиотечного модуля)
2. Вторая версия - `RP_from_altsyncram` (дополнительное редактирование)
3. Третья версия - `RP_from_megawizard` (создание с помощью MegaWizard)
4. Четвертая версия - `RP_from_template` (создание на языке VHDL)

Обратите внимание на то, что в QII при создании проекта верхнего уровня можно в качестве шаблона использовать сформированные ранее менеджером MegaWizard файлы с декларацией компонентов и файлы с шаблонами для их установки в проект. Следует напомнить, что первые имеют расширение `.cmp`, а вторые дополнительное слово `_inst` в имени файла.

## 6. Создание модуля регистровой памяти для конвейерного процессора

Основным форматом для команд RISC процессора является формат R, в котором задаются адреса трех регистров из РП:

- Два регистра RA и RB используются для выборки операндов
- Третий регистр RС используется для записи результата выполненной операции

Другим востребованным форматом является формат I, в котором непосредственный операнд задается прямо в самой команде. Разрядность его, как правило, составляет половину от длины команды.

**Требования к регистровой памяти RISC процессора:**

Для регистровой памяти RISC процессора потребуется трехпортовая память:
- Два порта в каждом такте читают содержимое двух регистров из РП
- Один порт может выполнять запись в РП

## Заключение

В методическом пособии рассмотрены различные способы создания модулей регистровой и оперативной памяти для процессорной системы:

1. Редактирование библиотечного модуля altsyncram
2. Использование помощника MegaWizard Plug-In Manager
3. Использование шаблонов на языке VHDL

Каждый из способов имеет свои преимущества и может быть использован в зависимости от требований проекта.
