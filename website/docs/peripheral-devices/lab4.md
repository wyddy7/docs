# Лабораторная работа №4

Страничный режим процессора X86.

## Сокращения

- **BIOS** – Base Input/Output System – базовая система ввода/вывода
- **WSL** – Windows Subsystem for Linux – подсистема Windows для Linux
- **MBR** – Master Boot Record – главная загрузочная запись
- **CHS** – Cylinder-Head-Sector – цилиндр-головка-сектор
- **GPT** – GUID (Globally Unique Identifier) Partition Table – таблица разделов глобальных уникальных идентификаторов
- **LBA** – Logical Block Addressing – логическая блочная адресация
- **AT&T** – American Telephone and Telegraph
- **GDT** – Global Descriptor Table – глобальная таблица дескрипторов
- **LDT** – Local Descriptor Table – локальная таблица дескрипторов
- **GDTR** – Global Descriptor Table Register – регистр глобальной таблицы дескрипторов
- **IDT** – Interrupt Descriptor Table – дескрипторная таблица прерываний
- **IDTR** – Interrupt Descriptor Table Register – регистр дескрипторной таблицы прерываний
- **PIC** – Programmable Interrupt Controller – программируемый контроллер прерываний
- **PF** – Page Fault – страничная ошибка
- **PTE** – Page Table Entries – записи таблицы страниц
- **PDE** – Page Directory Entries – записи каталога страниц
- **PDBR** – Page Directory Base Register – регистр базы каталога страниц

## Цель работы

Изучение механизма работы страничного режима и принципов реализации виртуальной памяти.

В процессе выполнения работы студенты:

- Разберутся в основах организации виртуальной памяти.
- Изучат работу страничного режима процессора x86.
- Проведут тестирование исключения #PF (Page Fault).

## Необходимые инструменты

- Любой дистрибутив GNU/Linux: рекомендуется Ubuntu, также можно использовать виртуальную машину, например, WSL
- Ассемблер: `as`
- Компоновщик: `ld`
- Утилиты для анализа объектных файлов: `objdump`, `readelf`
- Препроцессор: `cpp`
- Утилита для работы с дисками: `dd`
- Отладчик: `gdb`
- Эмулятор: `qemu`
- Утилиты для автоматизации сборки проектов: `make`

## Исходные файлы лабораторной работы

- **linker.ld** — скрипт линковщика для основной программы
- **Makefile** — необходимый для автоматизированной сборки проекта
- **lab4.S** — программа с реализацией страничного режима
- **gdt.h, idt.h, irq.h** — заголовочные файлы с макросами и константами
- **boot.S** — код загрузчика
- **Makefile** — для автоматизированной сборки загрузчика
- **linker.ld** — для сборки загрузчика

## Материалы для подготовки к лабораторной работе

### Страничная организация памяти

Механизм управления памятью возможно реализовать только в защищённом режиме. В этом режиме обращение к памяти процессор использует пару значений — селектор:смещение. Адрес указанный таким образом называется логическим адресом, т.к. смещение задаётся относительно начала сегмента, размещённого по любому адресу. С линейными адресами вы уже сталкивались, во 2 и 3 лабораторной работе, когда определяли дескрипторы и регистры IDTR и GDTR, задавая базовые адреса этих объектов. После вычисления линейного адреса процессор преобразует его в физический адрес, по которому и производит обращение к памяти.

**Зачем нужен физический адрес, если линейный адрес уже однозначно определяет доступ к памяти?**

Смысл в использовании линейных и физических адресов появляется, когда программа включает в процессоре механизм трансляции страниц. Страницей называется непрерывная область памяти фиксированного размера размером 4Кб. Всё адресное пространство можно разбить на страницы, получается 1048576 страниц, которые полностью покрывают 32-разрядное адресное пространство.

Адрес страницы памяти всегда кратен 4Кб (1000h байт), т.е. страница может начинаться только с адреса, у которого младшие 3 hex-разряда (или младшие 12 двоичных разрядов) равны нулю. Физическая память - эта та, которая реализована в компьютере в виде микросхем. Вся физическая память делится на физические страницы. Адресное пространство равно 4Гб и оно делится на логические страницы. Таким образом, логические страницы соответствуют физическим страницам или другими словами, логические страницы отображаются на физические страницы.

Страница имеет свой логический адрес, но может быть отображена на любой физический.

Логические страницы являются виртуальными объектами и каждая такая страница имеет два адреса:
- **линейный** - тот, по которому она расположена в адресном пространстве процессора,
- **физический** - тот, на который она отображена в физической памяти компьютера.

Если линейный адрес совпадает с физическим, то страница тождественно отображена.

Теперь очевидна необходимость в преобразовании линейного адреса в физический, т.к. заранее неизвестно, на какую физическую страницу памяти отображена данная логическая страница.

**Доступ к памяти через страницы работает по принципу:**
- выбор страницы – указываем процессору, какую именно страницу использовать (например, через её номер в таблице)
- смещение внутри страницы – задаём 12-битное смещение (поскольку стандартный размер страницы – 4 КБ = 2¹² байт)

Страничная организация памяти позволяет реализовать механизм виртуальной памяти на уровне процессора. В современных компьютерах объем физической памяти часто меньше 4 ГБ, но благодаря тому, что логическую страницу памяти можно отобразить не только на оперативную память, но и на дисковое пространство, фактически доступный объем памяти значительно увеличивается. При этом содержимое неактивных страниц может быть выгружено с диска обратно в ОЗУ по мере необходимости. Таким образом, общий объем используемой памяти ограничивается уже не размером оперативной памяти, а емкостью жесткого диска (или пропускной способностью сети в случае бездисковых систем, где хранение данных осуществляется удаленно).

### Таблицы и каталоги страниц

В программе можно использовать любое количество страниц памяти, но все они должны быть явно определены. Таблицы страниц — массивы, размером 4 Кб, состоящие из 1024 элементов. Таблица страниц должна быть выравнена на границу 4Кб и она хранит описания 1024 страниц, что позволяет описать 4 Мегабайта адресного пространства (1024 страниц по 4Кб каждая). Таблицы страниц группируются в каталог страниц - массив, размером в 4Кб, также состоящий из 1024 элементов. Каждый такой элемент является указателем на таблицу страниц.

Программе совсем не обязательно определять все страницы, таблицы и элементы каталога. Достаточно определить только те, которые реально будут использоваться и динамически добавлять / убирать новые описания в процессе работы. Однако, обязательно нужно определить каталог страниц, а в нём - хотя бы один указатель. То же самое касается таблиц страниц - хотя бы одну с одним элементом.

Для доступа к памяти нужно задать 32-разрядную структуры данных: 10 бит - номер таблицы, ещё 10 - номер страницы в таблице и 12 - смещение внутри самой страницы. Процессор использует описания страниц автоматически. Для этого он преобразует линейные адреса по следующей схеме:

Страничная организация памяти существенно усиливает механизмы защиты ОС, поскольку:
- каждая программа работает со своими виртуальными адресами, не зная реальных физических адресов
- программа не может напрямую обратиться к памяти ядра или других процессов, так как её виртуальные адреса отображаются только на разрешённые физические страницы
- попытка доступа к запрещённой области вызовет исключение #PF (Page Fault), и ОС завершит процесс

### Таблица страниц

Таблица страниц (Page Table) состоит из 4-байтовых элементов (Entries). Эти элементы называются PTE (Page Table Entries) и представляют собой указатели на страницы.

Если страница не присутствует в памяти (бит P=0), то процессор не использует все остальные биты элемента PTE и программа может их использовать по своему усмотрению, например, хранить информацию о том, куда эту страница была перемещена.

**Формат PTE:**

- **Бит 0 (P)** - Present - присутствие. Если 0, то страница не отображена на физическую память.
- **Бит 1 (R/W)** - Read/Write - Чтение/Запись. Если 0, то для этой страницы разрешено только чтение, 1 - чтение и запись.
- **Бит 2 (U/S)** - User/Supervisor - Пользователь/Система. Если 0, то доступ к странице разрешён только с нулевого уровня привилегий, если 1 - то со всех.
- **Бит 3 (PWT)** - Write-Through - Сквозная запись.
- **Бит 4 (PCD)** - Cache Disabled - Кэширование запрещено.
- **Бит 5 (A)** - Accessed - Доступ. Устанавливается процессором каждый раз, когда он производит обращение к данной странице.
- **Бит 6 (D)** - Dirty - Грязный. Устанавливается каждый раз, когда процессор производит запись в данную страницу.
- **Бит 7 (PAT)** - Page Table Attribute Index - Индекс атрибута таблицы страниц.
- **Бит 8 (G)** - Global Page - Глобальная страница.
- **Биты 9-11** - Доступно для использования программой.
- **Биты 12-31** - Базовый адрес страницы - это адрес, с которого начинается страница, другими словами - это физический адрес, на который отображена данная страница.

### Каталог страниц

Каталог страниц - это массив размером в 4Кб, состоящий из 4-байтовых элементов PDE (Page Directory Entries). Каждый элемент указывает на таблицу страниц и по формату почти совпадает с PTE. Элемент PDE определяет положение таблицы страниц, указывая адрес физической страницы памяти.

Если таблица страниц не присутствует в памяти (бит P=0), то процессор не использует все остальные биты элемента PDE и программа может их использовать по своему усмотрению.

**Формат PDE:**

- **Бит 0 (P)** - Present - присутствие. Если 0, то таблица страниц не отображена на физическую память.
- **Бит 1 (R/W)** - Read/Write - Чтение/Запись. Если 0, то для всех страниц этой таблицы разрешено только чтение, 1 - чтение и запись.
- **Бит 2 (U/S)** - User/Supervisor - Пользователь/Система. Если 0, то доступ ко всем страницам данной таблицы разрешён только с нулевого уровня привилегий, если 1 - то со всех.
- **Бит 3 (PWT)** - Write-Through - Сквозная запись.
- **Бит 4 (PCD)** - Cache Disabled - Кэширование запрещено.
- **Бит 5 (A)** - Accessed - Доступ. Устанавливается процессором каждый раз, когда он производит обращение к страницам данной таблицы страниц.
- **Бит 6** - 0 (зарезервировано).
- **Бит 7 (PS)** - Page size - Размер страницы. Если 0, то используются страницы размером 4Кб и данный элемент PDE указывает на таблицу страниц. Если флаг PS установлен в 1, то данный элемент PDE указывает на страницу размером 4Мб.
- **Бит 8 (G)** - Global Page - Глобальная страница. В PDE этот бит процессором игнорируется.
- **Биты 9-11** - Доступно для использования программой.
- **Биты 12-31** - Базовый адрес таблицы страниц - это адрес, с которого начинается таблица страниц, другими словами - это физический адрес, на который она отображена.

### Регистр PDBR

Для того, чтобы процессор мог использовать страничное преобразование, ему необходимо указать адрес начала каталога страниц. Этот адрес хранится в регистре PDBR (Page Directory Base Register - регистр базы каталога страниц). Функцию этого регистра выполняет регистр управления CR3, т.е. PDBR - это синоним CR3.

Т.к. каталог страниц должен быть выравнен на границу 4Кб, его адрес будет содержать нули в младших 12 разрядах, а 20 старших, следовательно, будут нести информацию. Эти 20 разрядов и хранятся в регистре CR3. Оставшиеся 12 бит в CR3 зарезервированы.

Для того, чтобы загрузить значение в CR3, можно использовать только команду MOV (как и для всех регистров управления). Т.к. регистры управления - 32-разрядные, то вторым операндом команды MOV должен быть 32-разрядный регистр общего назначения (как правило, это EAX).

### Включение страничного преобразования

Для активации страничной адресации в программе необходимо выполнить три ключевых шага:

1. подготовить описания всех используемых в программе страниц, таблиц страниц и каталога страниц
2. загрузить адрес начала (т.е. базовый адрес) каталога страниц в CR3
3. разрешить в процессоре страничное преобразование

Для того, чтобы включить или, другими словами, разрешить в процессоре страничное преобразование, необходимо установить бит PG (это 31-й бит) в регистре управления CR0. После того, как это будет сделано, нужно выполнить команду перехода - она заставит процессор сбросит конвейер и начать выборку команд уже используя механизм трансляции страниц. Перед возвратом программы в режим реальных адресов нужно запретить страничное преобразование - сбросить бит PG в CR0 и выполнить команду перехода

## Выполнение лабораторной работы

### Часть 1. Подготовка к выполнению лабораторной работы

1. Создайте директорию для выполнения лабораторной работы `mkdir lab4` и перейти в неё `cd lab4`, создайте директорию `img`, в ней будут храниться файлы необходимые для загрузчика.
2. Создайте по примеру лабораторной работы №3 необходимые для данной лабораторной работы файлы упомянутые в разделе исходные файлы. Скопируйте код предоставленный в приложении.

### Часть 2. Выполнение лабораторной работы 4

1. Соберите программу с помощью `make`, запустите её, наблюдайте успешное выполнение.
2. Запустите программу с поддержкой GDB, и подключитесь через него.
3. Установите точку останова в начале функции `set_pages`(адрес начала определите используя инструментарий, который применяли во время выполнения предыдущих работ) и продолжите выполнение.
4. Исследуйте память по адресу 0x9000 (будущий каталог страниц).
5. Установите точку останова после заполнения каталога страниц, перед инициализацией первой таблицы страниц, и продолжите выполнение, проанализируйте содержимое каталога страниц.
6. Проанализируйте содержимое таблиц страниц до и после инициализации.
7. Изучите содержимое регистров CR3, CR0.
8. В GDB выведите содержимое сегмента данных используя первую таблицу страниц(адреса тождественны), определите используя теорию линейный адрес которому соответствует этот же физический адрес при обращении через вторую таблицу страниц.

### Часть 3. Индивидуальное задание

Выберите из таблицы вариант соответствующий вашему номеру в списке группы.

В соответствии с вариантом вам необходимо определить область физической памяти, на которую вам необходимо будет отобразить сегмент заданного размера (например, дробь 7/8 означает что необходимо отобразить 1024 КБ/8 = 128 КБ на физическую область памяти начиная с адреса 0x1C0000(используем только второй мегабайт физической памяти)). Также необходимо добавить дескриптор с правами только на чтение который будет описывать данный сегмент памяти при выключенном страничном преобразовании. Затем с включенным страничным преобразованием необходимо заполнить данный сегмент возрастающими двойными словами, выключить страничное преобразование и прочитать записанные данные, совпадение записанных и считанных данных является доказательством успешного выполнения лабораторной работы. Также необходимо учесть, что в сегменте, содержащем каталог и таблицы страниц, каталог страниц должен находиться на странице с номером внутри сегмента соответствующем варианту. Базовый адрес данного сегмента также указан в таблице. Записи для страниц с номерами i и j в таблице страниц необходимо поменять местами, в дальнейшем при чтении без страничного преобразования необходимо пронаблюдать результат этого действия.

## Приложение

Полный код программ, Makefile, linker.ld и другие файлы находятся в исходных документах лабораторной работы.

